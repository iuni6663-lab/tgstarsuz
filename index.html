<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yban Premium | Digital Services</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #0088cc;
            --primary-dark: #006699;
            --bg-dark: #0a0b10;
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent-gradient: linear-gradient(135deg, #0088cc 0%, #00c6ff 100%);
            --pending: #f1c40f;
            --approved: #3498db;
            --done: #2ecc71;
            --rejected: #e74c3c;
        }

        body {
            background-color: var(--bg-dark);
            color: #ffffff;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Background Glows */
        .bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(0, 136, 204, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(0, 198, 255, 0.1) 0%, transparent 40%);
        }

        .container-main { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

        /* Login Screen */
        .auth-wrapper {
            height: 100vh; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 30px;
        }
        .auth-card {
            background: var(--card-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 35px;
            padding: 40px 30px; width: 100%; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        /* App UI Components */
        .app-header {
            padding: 30px 20px; background: rgba(255,255,255,0.02);
            backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
            border-radius: 0 0 30px 30px; margin-bottom: 25px;
        }
        .user-avatar {
            width: 55px; height: 55px; border-radius: 18px; 
            border: 2px solid var(--primary); padding: 2px;
        }

        /* Product Cards */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .product-card {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 20px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; overflow: hidden; cursor: pointer;
        }
        .product-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .product-card.active {
            background: rgba(0, 136, 204, 0.1); border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 136, 204, 0.2);
        }
        .product-card.active::after {
            content: "\f058"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 10px; right: 10px; color: var(--primary);
        }
        .stars-img { width: 45px; margin-bottom: 12px; filter: drop-shadow(0 5px 15px rgba(255,215,0,0.3)); }
        .price-tag { font-size: 0.85rem; color: #aaa; margin-top: 5px; }

        /* Input Field */
        .premium-input-box {
            background: var(--card-bg); border-radius: 24px; padding: 20px;
            margin: 25px 0; border: 1px solid var(--glass-border);
        }
        .custom-input {
            background: rgba(0,0,0,0.2) !important; border: 1px solid var(--glass-border) !important;
            color: #fff !important; border-radius: 14px; padding: 12px 15px;
        }
        .custom-input:focus { border-color: var(--primary) !important; box-shadow: none !important; }

        /* Order History */
        .history-card {
            background: var(--card-bg); border-radius: 20px; padding: 15px;
            margin-bottom: 15px; border-left: 4px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center;
        }
        .status-badge {
            padding: 6px 12px; border-radius: 10px; font-size: 0.65rem;
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .badge-pending { background: rgba(241, 196, 15, 0.15); color: var(--pending); }
        .badge-approved { background: rgba(52, 152, 219, 0.15); color: var(--approved); }
        .badge-done { background: rgba(46, 204, 113, 0.15); color: var(--done); }
        .badge-rejected { background: rgba(231, 76, 60, 0.15); color: var(--rejected); }

        /* Sticky Bottom Navbar */
        .bottom-action {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; background: rgba(10, 11, 16, 0.8);
            backdrop-filter: blur(20px); padding: 20px; border-top: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }
        .btn-buy {
            background: var(--accent-gradient); color: #fff; border: none;
            padding: 15px 35px; border-radius: 18px; font-weight: 800;
            box-shadow: 0 10px 25px rgba(0, 136, 204, 0.4);
            transition: 0.3s;
        }
        .btn-buy:active { transform: scale(0.95); }

        /* Loader */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div class="bg-glow"></div>

<div id="app-loader" class="loader-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 opacity-50">Yuklanmoqda...</p>
    </div>
</div>

<div class="container-main">

    <div id="view-auth" class="auth-wrapper animate__animated animate__fadeIn" style="display: none;">
        <div class="auth-card">
            <div class="mb-4">
                <i class="fab fa-telegram fa-4x text-primary mb-3"></i>
                <h3 class="fw-800">Yban Premium</h3>
                <p class="text-muted small">Bizning xizmatlardan foydalanish uchun Telegram orqali kiring</p>
            </div>
            
            <div id="tg-widget-container">
                </div>
            
            <p class="mt-4 small text-muted">Xavfsiz va rasmiy Telegram login</p>
        </div>
    </div>

    <div id="view-app" style="display: none;">
        <header class="app-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <img id="user-pfp" src="" class="user-avatar">
                <div>
                    <h6 id="user-display-name" class="mb-0 fw-bold">...</h6>
                    <small id="user-tag" class="text-muted">@username</small>
                </div>
            </div>
            <button class="btn btn-link text-muted" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <div class="px-3">
            <h5 class="fw-bold mb-3"><i class="fas fa-gem text-primary me-2"></i> Paketlar</h5>
            
            <div class="grid-container" id="product-grid">
                </div>

            <div class="premium-input-box animate__animated animate__fadeInUp">
                <label class="small fw-bold mb-3 text-uppercase text-muted">Ma'lumotlar</label>
                <div class="input-group mb-0">
                    <span class="input-group-text bg-transparent border-0 text-primary">@</span>
                    <input type="text" id="target-id" class="form-control custom-input" placeholder="Telegram Username">
                </div>
                <small class="text-muted mt-2 d-block px-1" style="font-size: 0.7rem;">
                    * Premium yuboriladigan foydalanuvchi nomini yozing.
                </small>
            </div>

            <div class="mb-5">
                <h5 class="fw-bold mb-4"><i class="fas fa-history text-primary me-2"></i> Buyurtmalar Tarixi</h5>
                <div id="order-history-list">
                    </div>
            </div>
        </div>

        <div class="bottom-action animate__animated animate__slideInUp">
            <div>
                <small class="text-muted d-block fw-bold small">TO'LOV:</small>
                <h4 id="display-price" class="mb-0 fw-800 text-white">0 so'm</h4>
            </div>
            <button class="btn-buy" onclick="handleCheckout()">SOTIB OLISH</button>
        </div>
    </div>

</div>

<script>
    // -----------------------------------------------------------------
    // 1. FIREBASE ARCHITECTURE
    // -----------------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDgMXCfXW_I70t0m-pZhfi7HTbiCBB70dg",
        authDomain: "tgstars-29ae3.firebaseapp.com",
        databaseURL: "https://tgstars-29ae3-default-rtdb.firebaseio.com",
        projectId: "tgstars-29ae3",
        appId: "1:1031854102638:web:8da862f0ddbf0f3421ae7f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // -----------------------------------------------------------------
    // 2. PRODUCT CONFIGURATION
    // -----------------------------------------------------------------
    const PRODUCTS = [
        { id: 'stars_50', label: '50 Stars', price: 15000, img: 'https://telegram.org/img/tgstars.png' },
        { id: 'stars_100', label: '100 Stars', price: 29000, img: 'https://telegram.org/img/tgstars.png' },
        { id: 'stars_250', label: '250 Stars', price: 69000, img: 'https://telegram.org/img/tgstars.png' },
        { id: 'stars_500', label: '500 Stars', price: 135000, img: 'https://telegram.org/img/tgstars.png' },
        { id: 'stars_1000', label: '1000 Stars', price: 265000, img: 'https://telegram.org/img/tgstars.png' },
        { id: 'stars_2500', label: '2500 Stars', price: 650000, img: 'https://telegram.org/img/tgstars.png' }
    ];

    let currentSession = {
        user: null,
        selectedProduct: null,
        target: ''
    };

    // -----------------------------------------------------------------
    // 3. CORE LOGIC & WIDGET EMBED
    // -----------------------------------------------------------------
    window.onload = function() {
        checkSession();
        injectWidget();
    };

    function injectWidget() {
        const container = document.getElementById('tg-widget-container');
        const script = document.createElement('script');
        script.async = true;
        script.src = "https://telegram.org/js/telegram-widget.js?22";
        script.setAttribute('data-telegram-login', 'starsuz_authbot'); // @BotFather domain ulanishi kerak
        script.setAttribute('data-size', 'large');
        script.setAttribute('data-radius', '15');
        script.setAttribute('data-onauth', 'onTelegramAuth(user)');
        container.appendChild(script);
    }

    // Global callback for Telegram Widget
    window.onTelegramAuth = function(user) {
        currentSession.user = user;
        localStorage.setItem('yban_user', JSON.stringify(user));
        toggleView('view-app');
        initUserUI();
    };

    function checkSession() {
        const saved = localStorage.getItem('yban_user');
        setTimeout(() => {
            document.getElementById('app-loader').style.display = 'none';
            if (saved) {
                currentSession.user = JSON.parse(saved);
                toggleView('view-app');
                initUserUI();
            } else {
                toggleView('view-auth');
            }
        }, 1200);
    }

    function initUserUI() {
        const u = currentSession.user;
        document.getElementById('user-pfp').src = u.photo_url || 'https://via.placeholder.com/100';
        document.getElementById('user-display-name').innerText = u.first_name;
        document.getElementById('user-tag').innerText = `@${u.username || 'user_' + u.id}`;
        
        renderProducts();
        syncOrders();
    }

    function renderProducts() {
        const container = document.getElementById('product-grid');
        container.innerHTML = PRODUCTS.map(p => `
            <div class="product-card" id="card-${p.id}" onclick="selectProduct('${p.id}')">
                <img src="${p.img}" class="stars-img">
                <div class="fw-bold">${p.label}</div>
                <div class="price-tag">${p.price.toLocaleString()} so'm</div>
            </div>
        `).join('');
    }

    function selectProduct(id) {
        currentSession.selectedProduct = PRODUCTS.find(p => p.id === id);
        document.querySelectorAll('.product-card').forEach(c => c.classList.remove('active'));
        document.getElementById(`card-${id}`).classList.add('active');
        document.getElementById('display-price').innerText = currentSession.selectedProduct.price.toLocaleString() + ' so\'m';
    }

    // -----------------------------------------------------------------
    // 4. FIREBASE OPERATIONS
    // -----------------------------------------------------------------
    async function handleCheckout() {
        const target = document.getElementById('target-id').value;
        if (!currentSession.selectedProduct) return alert('Iltimos, paket tanlang!');
        if (!target) return alert('Username kiriting!');

        const orderId = "ORD-" + Date.now().toString(36).toUpperCase();
        const orderData = {
            orderId: orderId,
            userId: currentSession.user.id,
            target: target,
            productId: currentSession.selectedProduct.id,
            productLabel: currentSession.selectedProduct.label,
            price: currentSession.selectedProduct.price,
            status: 'pending',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        try {
            await database.ref('orders/' + orderId).set(orderData);
            // Click P2P link Integration
            window.location.href = "https://my.click.uz/clickp2p/30325C351A3F7F8C133EC334D17080FB834F5478346C01564BA3C310DA04F48F";
        } catch (error) {
            console.error("Firebase Error:", error);
            alert("Xatolik yuz berdi. Qayta urinib ko'ring.");
        }
    }

    function syncOrders() {
        const historyList = document.getElementById('order-history-list');
        const userRef = database.ref('orders').orderByChild('userId').equalTo(currentSession.user.id);

        userRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                historyList.innerHTML = '<div class="text-center opacity-50 py-4 small">Buyurtmalar mavjud emas</div>';
                return;
            }

            const sorted = Object.values(data).sort((a, b) => b.createdAt - a.createdAt);
            
            historyList.innerHTML = sorted.map(order => `
                <div class="history-card animate__animated animate__fadeIn">
                    <div>
                        <div class="fw-bold small">${order.productLabel}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">@${order.target}</div>
                    </div>
                    <div class="text-end">
                        <div class="status-badge badge-${order.status}">${getStatusName(order.status)}</div>
                        <div class="mt-1 fw-bold" style="font-size: 0.8rem;">${order.price.toLocaleString()} s</div>
                    </div>
                </div>
            `).join('');
        });
    }

    // -----------------------------------------------------------------
    // 5. HELPER UTILS
    // -----------------------------------------------------------------
    function getStatusName(status) {
        const mapping = {
            'pending': 'Kutilmoqda',
            'approved': 'Tasdiqlandi',
            'done': 'Bajarildi',
            'rejected': 'Bekor qilindi'
        };
        return mapping[status] || status;
    }

    function toggleView(viewId) {
        document.getElementById('view-auth').style.display = 'none';
        document.getElementById('view-app').style.display = 'none';
        document.getElementById(viewId).style.display = 'block';
    }

    function logout() {
        localStorage.removeItem('yban_user');
        location.reload();
    }
</script>

</body>
</html>
